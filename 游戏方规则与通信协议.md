# 谁是卧底 · 游戏方规则与通信协议

## 1. 文档目的
- 由主持人统一发送给全部参赛组，确保对游戏流程、交流约定和行为规范有一致理解。
- 涵盖基础规则、术语定义、通信协议以及异常处理办法。

## 2. 基础流程概览
1. 通过注册接口提交唯一的 `group_name`（推荐使用队名或谐音）。
2. 等待主持人宣布开局并接收身份及词语。
3. 主持人开启描述阶段后，按提示完成描述。
4. 主持人开启投票阶段后，提交本轮投票。
5. 主持人处理投票并公布淘汰结果、得分及下一轮安排。
6. 重复“描述-投票”直到判定胜负。

## 3. 角色与术语
- **游戏方**：参赛小组，使用本协议与主持端交互。
- **主持端**：Undercover 主持平台，负责身份分配、回合控制、积分统计。
- **平民词 / 卧底词**：主持人分配给不同身份的词语，两个词语语义相近。
- **描述阶段**：主持人开放时间段，允许每组提交一次描述。
- **投票阶段**：主持人开放时间段，允许每组提交一次投票对象。

## 4. 行为规范
- 描述为一句话，建议 5~30 个汉字。
- 禁止在描述中直接说出词语本体或透露身份。
- 描述、投票均仅能提交一次，提交后不可撤销。
- 如遇网络问题导致无法提交，主持端会自动检测并记录异常。

## 5. 通信约定

### 5.1 基础设置
- 协议：HTTP/HTTPS JSON API，字符集 UTF-8。
- 身份：`group_name` 在注册后即为唯一凭据；请勿与他人共享。
- 主持方控制接口（`/api/game/*`）受 `X-Admin-Token` 保护，仅主持端使用。
- 游戏方只需调用本节列出的开放接口。

### 5.2 开放 API 一览

| 场景 | 方法 | 路径 | 请求示例 | 响应示例 | 说明 |
|------|------|------|----------|----------|------|
| 注册组名 | `POST` | `/api/register` | `{ "group_name": "望月队" }` | `{ "code": 200, "message": "注册成功", "data": { "group_name": "望月队", "total_groups": 3 } }` | 每组仅注册一次 |
| 获取词语 | `GET` | `/api/word?group_name=望月队` | — | `{ "code": 200, "message": "ok", "data": { "word": "向日葵" } }` | 仅返回自己的词语 |
| 获取阶段状态 | `GET` | `/api/status?group_name=望月队` | — | `{ "code": 200, 
"message": "ok", "data": { "status": "describing", "round": 2, 
"describe_order": ["望月队","青木队"], "eliminated_groups": [] } }`详见5.3 | 轮询频率
≤1次/3秒，建议传递 `group_name` 参数以更新活跃状态 |
| 获取描述列表 | `GET` | `/api/descriptions?round=1` | — | `{ "code": 200, "message": "ok", "data": { "round": 1, "descriptions": [{ "group": "望月队", "description": "偏爱夜景的城市" }], "total": 3 } }` | 获取指定回合的描述列表，`round` 参数可选，默认当前回合 |
| 提交描述 | `POST` | `/api/describe` | `{ "group_name": "望月队", "description": "偏爱夜景的城市" }` | `{ "code": 200, "message": "描述提交成功", "data": { "round": 2, "total_descriptions": 3 } }` | 仅限描述阶段，需按发言顺序提交 |
| 提交投票 | `POST` | `/api/vote` | `{ "voter_group": "望月队", "target_group": "青木队" }` | `{ "code": 200, "message": "投票提交成功", "data": {} }` | 仅限投票阶段，禁止投自己 |
| 获取最新结果 | `GET` | `/api/result` | — | `{ "code": 200, "message": "ok", "data": { "round": 2, "eliminated": ["青木队"], "game_ended": false } }` | 投票处理完成后可查 |
| 获取所有组 | `GET` | `/api/groups` | — | `{ "code": 200, "message": "ok", "data": { "groups": [{ "name": "望月队", "registered_time": "2025-01-01T10:00:00", "eliminated": false }], "total": 3 } }` | 获取所有已注册的组信息 |

> **提示**：所有响应体均采用 `{ "code": <状态码>, "message": "<文字信息>", "data": { ... } }` 结构；当 `code != 200` 时，需根据 `message` 判断失败原因。

### 5.3 `/api/status` 接口详细说明

`/api/status` 接口返回完整的游戏状态信息，响应 `data` 字段包含：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `status` | `string` | 游戏状态：`waiting`（等待注册）、`registered`（已注册）、`word_assigned`（词语已分配）、`describing`（描述阶段）、`voting`（投票阶段）、`round_end`（回合结束）、`game_end`（游戏结束） |
| `round` | `number` | 当前回合数 |
| `active_groups` | `array` | 当前活跃的组名列表（未淘汰的组） |
| `describe_order` | `array` | 描述阶段的发言顺序（仅在描述/投票阶段返回） |
| `current_speaker` | `string\|null` | 当前应该发言的组名（仅在描述阶段返回） |
| `current_speaker_index` | `number\|null` | 当前发言者在顺序中的索引（仅在描述阶段返回） |
| `eliminated_groups` | `array` | 已淘汰的组名列表 |
| `remaining_seconds` | `number\|null` | 当前阶段剩余时间（秒） |
| `speaker_remaining_seconds` | `number\|null` | 当前发言者剩余时间（秒，仅在描述阶段返回） |
| `descriptions` | `array` | 当前回合已提交的描述列表，格式：`[{ "group": "组名", "description": "描述内容" }]` |
| `voted_groups` | `array` | 当前回合已投票的组名列表 |

**响应示例**：
```json
{
  "code": 200,
  "message": "ok",
  "data": {
    "status": "describing",
    "round": 1,
    "active_groups": ["望月队", "青木队", "红叶队"],
    "describe_order": ["望月队", "青木队", "红叶队"],
    "current_speaker": "望月队",
    "current_speaker_index": 0,
    "eliminated_groups": [],
    "remaining_seconds": 150,
    "speaker_remaining_seconds": 25,
    "descriptions": [
      { "group": "望月队", "description": "偏爱夜景的城市" }
    ],
    "voted_groups": []
  }
}
```

## 6. 时间与频率限制
- 注册需在主持人公布的截止时间前完成，逾期无法参与当局。
- 状态轮询：建议 2~3 秒一次；请勿并发刷接口。
- 描述提交：每个发言者限时 30 秒，描述阶段总时长 180 秒，每个人都必须发言。
- 投票提交：投票阶段限时 120 秒，每个人都必须投票。
- 活跃状态：调用 `/api/status` 时建议传递 `group_name` 参数，用于更新活跃状态（60秒未活跃视为离线）。

## 7. 异常处理
- 如遇网络问题导致无法提交，主持端会自动检测并记录异常。
- 超时未提交的组会在主持端异常记录中显示。
- 建议游戏方客户端定期轮询 `/api/status` 接口，及时获取游戏状态更新。

